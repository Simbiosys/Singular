<?php	namespace Singular;	class Database {		private $provider;		private $parameters;		private static $_con;		public function __construct($provider, $server, $user, $password, $data_base) {			if (!class_exists($provider)) {				throw new \Exception("Provider does not exist or is not implemented.");			}			$this->provider = new $provider;			$this->provider->connect($server, $user, $password, $data_base);			if (!$this->provider->is_there_connection()) {				throw new \Exception("Connection to dabase '$data_base' cannot be established.");			} else {				$this->provider->set_charset('utf-8');			}		}		public static function get_connection($provider, $server, $user, $password, $data_base) {			if (self::$_con) {				return self::$_con;			} else {				$class = __CLASS__;				self::$_con = new $class($provider, $server, $user, $password, $data_base);				return self::$_con;			}		}		private function replace_parameters() {			$b = current($this->params);			next($this->params);			return $b;		}		private function prepare($sql, $parameters) {			$escaped = '';			if ($parameters) {				foreach ($parameters as $key => $value) {					if (is_bool($value)) {						$value = $value ? 1 : 0;					} elseif (is_double($value)) {						$value = str_replace(',', '.', $value);					} elseif (is_numeric($value)) {						if (is_string($value)) {							$value = "'" . $this->provider->escape($value) . "'";						} else {							$value = $this->provider->escape($value);						}					} elseif (is_NULL($value)) {						$value = "NULL";					} else {						$value = "'" . $this->provider->escape($value) . "'";					}					$escaped[] = $value;				}			}			$this->params = $escaped;			$q = preg_replace_callback("/(\?)/i", array($this, "replace_parameters"), $sql);			return $q;		}		private function send_query($q, $parameters) {			$query = $this->prepare($q, $parameters);			$result = $this->provider->query($query);			if ($this->provider->get_error_number()) {				error_log($this->provider->get_error());			}			return $result;		}		public function run_scalar($q, $parameters = NULL) {			$result = $this->send_query($q, $parameters);			if (!is_NULL($result)) {				if (!is_object($result)) {					return $result;				} else {					$row = $this->provider->get_array($result);					return $row[0];				}			}			return NULL;		}		public function run($q, $indice = NULL, $parameters = NULL) {			$result = $this->send_query($q, $parameters);			if ((is_object($result) || $this->provider->number_of_rows($result) || $result) && ($result !== true && $result !== false)) {					$arr = array();					while ($row = $this->provider->get_array($result)) {							if ($indice) {									$arr[$row[$indice]] = $row;							} else {									$arr[] = $row;							}					}					return $arr;			}			return $this->provider->get_error_number() ? false : true;		}		public function change_database($database) {			$this->provider->change_database($database);		}		public function get_id() {			return $this->provider->get_id();		}		public function get_error() {			return $this->provider->get_error();		}		public function format_fields($data, $fields_structure) {			return $this->provider->format_fields($data, $fields_structure);		}		public function check_table($table, $fields, $primary_key) {			return $this->provider->check_table($table, $fields, $primary_key);		}		public function check_fields($table, $fields, $primary_key) {			return $this->provider->check_fields($table, $fields, $primary_key);		}		public function __destruct() {			$this->provider->disconnect();		}	}